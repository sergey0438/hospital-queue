<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ —á–µ—Ä–≥–∞</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #000;
  color: #fff;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: url('./bg_logo.png') no-repeat center center;
  background-size: 100%;
}

.header {
  width: 100%;
  text-align: center;
  padding: 1rem 0;
  background-color: rgba(0,0,0,0.6);
  font-size: 2rem;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.queue-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1rem;
  align-content: start;

  padding: 2rem;
  width: 100%;
  max-width: 1200px;

  height: calc(100vh - 220px);
  overflow-y: auto;
  overflow-x: hidden;

  margin-top: 2rem;
  scroll-behavior: smooth;
}

/* —Å–∫—Ä—ã—Ç—å scrollbar */
.queue-container::-webkit-scrollbar { display: none; }

.patient-card {
  background-color: #d32f2f;
  color: white;
  border-radius: 15px;
  padding: 1.5rem;
  text-align: center;
  font-size: 1.5rem;
  box-shadow: 0 0 15px rgba(255,0,0,0.7);
  transition: transform 0.5s, opacity 0.5s, box-shadow 0.3s;
  opacity: 0;
  transform: translateY(-20px);
}

.patient-card.show { opacity: 1; transform: translateY(0); }
.patient-number { font-size: 3rem; font-weight: bold; }
.patient-name { margin-top: 0.5rem; font-size: 1.5rem; font-weight: 500; }

@media (max-width: 768px) {
  .queue-container { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem; padding: 1rem; }
  .patient-card { padding: 1rem; font-size: 1.2rem; }
  .patient-number { font-size: 2rem; }
  .patient-name { font-size: 1.2rem; }
}

/* ===== ANTISLEEP –î–õ–Ø OLED / GOOGLE TV ===== */
@keyframes antiSleep {
  0%   { transform: translate(0, 0); }
  50%  { transform: translate(1px, 0); }
  100% { transform: translate(0, 0); }
}
body {
  animation: antiSleep 30s infinite linear;
  overflow: hidden;
}

/* ===== Overlay —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ===== */
.notice-overlay {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.65);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.35s ease;
  z-index: 9998;
}
.notice-overlay.show {
  opacity: 1;
  pointer-events: auto;
}
.notice-card {
  max-width: 900px;
  margin: 0 24px;
  padding: 24px 28px;
  background: #fff3cd;
  color: #111;
  border-radius: 16px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.35);
  text-align: center;
}
.notice-title {
  font-size: 2rem;
  font-weight: 800;
  margin-bottom: 12px;
}
.notice-text {
  font-size: 1.5rem;
  font-weight: 700;
}
</style>
</head>

<body>

<!-- ‚úÖ –ö–Ω–æ–ø–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∑–≤—É–∫–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è –¢–í/–±—Ä–∞—É–∑–µ—Ä–æ–≤) -->
<button id="unlock"
  class="btn btn-success btn-lg"
  style="position:fixed;bottom:20px;left:20px;z-index:9999;">
  üîä –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫
</button>

<!-- –∞–Ω—Ç–∏—Å–æ–Ω –≤–∏–¥–µ–æ -->
<video
  id="antiSleepVideo"
  autoplay
  loop
  muted
  playsinline
  preload="auto"
  style="position: fixed; top:0; left:0; width:1px; height:1px; opacity:0; pointer-events:none; z-index:-1;">
  <source src="antisleep.mp4" type="video/mp4">
</video>

<div class="header">–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ —á–µ—Ä–≥–∞</div>
<div class="header">–®–∞–Ω–æ–≤–Ω—ñ –ø–∞—Ü—ñ—î–Ω—Ç–∏! –ü—ñ—Å–ª—è –∑–Ω–∏–∫–Ω–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –Ω–æ–º–µ—Ä –º–æ–∂–µ –∑–∞—Ö–æ–¥–∏—Ç–∏ –¥–æ –∫–∞–±—ñ–Ω–µ—Ç—É ‚Ññ3.</div>

<div class="queue-container" id="queueScreen" tabindex="0"></div>

<!-- ‚úÖ Overlay —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="noticeOverlay" class="notice-overlay" aria-hidden="true">
  <div class="notice-card" role="dialog" aria-live="polite" aria-modal="true">
    <div class="notice-title">–®–∞–Ω–æ–≤–Ω—ñ –ø–∞—Ü—ñ—î–Ω—Ç–∏!</div>
    <div class="notice-text">
      –î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó —Ö–≤–æ—Ä–æ–±–∏ –û–ë–û–í'–Ø–ó–ö–û–í–û –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å –ó–∞–≤—ñ–¥—É–≤–∞—á–∞ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –Ω–∞ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–º—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ñ!
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
    authDomain: "hospital-queue.firebaseapp.com",
    databaseURL: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId: "hospital-queue",
    storageBucket: "hospital-queue.appspot.com",
    messagingSenderId: "23042968926",
    appId: "1:23042968926:web:9c75f87c5337af630653cf"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const queueScreen = document.getElementById('queueScreen');
  const noticeOverlay = document.getElementById('noticeOverlay');
  const unlockBtn = document.getElementById('unlock');

  let currentCards = {};
  let availableVoices = [];
  let soundUnlocked = false;

  let lastCallTs = 0;
  let lastSilenceDate = '';

  // ---------- Voices ----------
  function loadVoices() { availableVoices = speechSynthesis.getVoices(); }
  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;

  function getUkVoice() {
    if (!availableVoices.length) loadVoices();
    return availableVoices.find(v => v.lang === 'uk-UA') || availableVoices[0] || null;
  }

  // ---------- Unlock sound ----------
  unlockBtn.addEventListener('click', () => {
    soundUnlocked = true;

    const u = new SpeechSynthesisUtterance('–ó–≤—É–∫ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ');
    u.lang = 'uk-UA';
    const v = getUkVoice();
    if (v) u.voice = v;

    speechSynthesis.cancel();
    speechSynthesis.speak(u);

    unlockBtn.remove();
  });

  // ---------- Speak queue ----------
  function speakNext(number) {
    if (!soundUnlocked) {
      console.log('–ó–≤—É–∫ –Ω–µ —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ ‚Äî –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫"');
      return;
    }
    if (!('speechSynthesis' in window)) return;

    const text = `–ü–∞—Ü—ñ—î–Ω—Ç –∑ –Ω–æ–º–µ—Ä–æ–º ${number}, –í–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π`;
    const u = new SpeechSynthesisUtterance(text);

    const ukVoice = getUkVoice();
    if (ukVoice) u.voice = ukVoice;

    u.lang = 'uk-UA';
    u.rate = 0.9;
    u.pitch = 1;

    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  // ---------- Firebase: call ----------
  db.ref('call').on('value', snapshot => {
    const data = snapshot.val();
    if (!data) return;

    if (data.ts <= lastCallTs) return;
    lastCallTs = data.ts;

    speakNext(data.number);
  });

  // ---------- Queue cards ----------
  function createCard(key, data) {
    const card = document.createElement('div');
    card.className = 'patient-card';
    card.innerHTML = `
      <div class="patient-number">‚Ññ${key}</div>
      <div class="patient-name">${data.name ?? ''}</div>
    `;
    queueScreen.appendChild(card);
    setTimeout(() => card.classList.add('show'), 50);
    return card;
  }

  db.ref('queue').on('value', (snapshot) => {
    const newKeys = new Set();

    snapshot.forEach((s) => {
      const data = s.val();
      if (!data) return;

      if (data.status === 'waiting') {
        newKeys.add(s.key);
        if (!currentCards[s.key]) {
          currentCards[s.key] = createCard(s.key, data);
        }
      }
    });

    for (const key in currentCards) {
      if (!newKeys.has(key)) {
        const card = currentCards[key];
        card.classList.remove('show');
        setTimeout(() => card.remove(), 500);
        delete currentCards[key];
      }
    }
  });

  // ---------- Overlay notices ----------
  let noticeTimer = null;

  function showOverlay(title, text, ms) {
    // ‚ö†Ô∏è –ù–ï cancel() –∑–¥–µ—Å—å ‚Äî –∏–Ω–∞—á–µ —É–±—å—ë–º –æ–∑–≤—É—á–∫—É –æ—á–µ—Ä–µ–¥–∏
    noticeOverlay.querySelector('.notice-title').textContent = title;
    noticeOverlay.querySelector('.notice-text').textContent = text;
    noticeOverlay.classList.add('show');
    noticeOverlay.setAttribute('aria-hidden', 'false');

    if (noticeTimer) clearTimeout(noticeTimer);
    noticeTimer = setTimeout(() => {
      noticeOverlay.classList.remove('show');
      noticeOverlay.setAttribute('aria-hidden', 'true');
    }, ms);
  }

  // –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
  function showNotice() {
    showOverlay(
      '–®–∞–Ω–æ–≤–Ω—ñ –ø–∞—Ü—ñ—î–Ω—Ç–∏!',
      "–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó —Ö–≤–æ—Ä–æ–±–∏ –û–ë–û–í'–Ø–ó–ö–û–í–û –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å –ó–∞–≤—ñ–¥—É–≤–∞—á–∞ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –Ω–∞ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–º—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ñ!",
      8000
    );
  }

  // ---------- Minute of silence schedule (Kyiv time) ----------
  function getKyivDateTimeParts() {
    const parts = new Intl.DateTimeFormat('en-GB', {
      timeZone: 'Europe/Kyiv',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    }).formatToParts(new Date());

    const map = {};
    for (const p of parts) if (p.type !== 'literal') map[p.type] = p.value;

    return {
      dateKey: `${map.year}-${map.month}-${map.day}`,
      hour: map.hour,
      minute: map.minute
    };
  }

  function speakMinuteOfSilence() {
    if (!soundUnlocked) return; // ‚úÖ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–≤—É–∫ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
    if (!('speechSynthesis' in window)) return;

    const text = '–®–∞–Ω–æ–≤–Ω—ñ –ø–∞—Ü—ñ—î–Ω—Ç–∏! –û–≥–æ–ª–æ—à—É—î—Ç—å—Å—è —Ö–≤–∏–ª–∏–Ω–∞ –º–æ–≤—á–∞–Ω–Ω—è.';
    const u = new SpeechSynthesisUtterance(text);

    const ukVoice = getUkVoice();
    if (ukVoice) u.voice = ukVoice;

    u.lang = 'uk-UA';
    u.rate = 0.95;
    u.pitch = 1;

    // —Ç—É—Ç –º–æ–∂–Ω–æ –ø–µ—Ä–µ–±–∏—Ç—å –æ—á–µ—Ä–µ–¥—å (–ø–æ –∂–µ–ª–∞–Ω–∏—é):
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  function checkSilenceSchedule() {
    const now = getKyivDateTimeParts();

    // üëâ –ü–æ—Å—Ç–∞–≤—å —Å–≤–æ—ë –≤—Ä–µ–º—è —Ç—É—Ç (–ø—Ä–∏–º–µ—Ä: 09:00)
    const TARGET_HOUR = '20';
    const TARGET_MIN = '55';

    if (now.hour === TARGET_HOUR && now.minute === TARGET_MIN && now.dateKey !== lastSilenceDate) {
      lastSilenceDate = now.dateKey;

      showOverlay(
        '–•–≤–∏–ª–∏–Ω–∞ –º–æ–≤—á–∞–Ω–Ω—è',
        '–ü—Ä–æ—Å–∏–º–æ –≤—à–∞–Ω—É–≤–∞—Ç–∏ –ø–∞–º‚Äô—è—Ç—å –∑–∞–≥–∏–±–ª–∏—Ö.',
        60000 // 60 —Å–µ–∫—É–Ω–¥
      );

      speakMinuteOfSilence();
    }
  }

  // ---------- Start timers ----------
  window.addEventListener('load', () => {
    // –ø–µ—Ä–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫ (—á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å –∑–∞–ø—É—Å–∫—É)
    setTimeout(showNotice, 5000);

    // –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
    setInterval(showNotice, 5 * 60 * 1000);

    // –ø—Ä–æ–≤–µ—Ä–∫–∞ "—Ö–≤–∏–ª–∏–Ω–∞ –º–æ–≤—á–∞–Ω–Ω—è" –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫
    checkSilenceSchedule();
    setInterval(checkSilenceSchedule, 20 * 1000);
  });
</script>

</body>
</html>
