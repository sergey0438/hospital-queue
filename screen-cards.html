<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Електронна черга</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #000;
  color: #fff;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: url('./bg_logo.png') no-repeat center center;
  background-size: 100%;
}

.header {
  width: 100%;
  text-align: center;
  padding: 1rem 0;
  background-color: rgba(0,0,0,0.6);
  font-size: 2rem;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.queue-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1rem;
  align-content: start;

  padding: 2rem;
  width: 100%;
  max-width: 1200px;

  height: calc(100vh - 220px);
  overflow-y: auto;
  overflow-x: hidden;

  margin-top: 2rem;
  scroll-behavior: smooth;
}
.queue-container::-webkit-scrollbar { display: none; }

.patient-card {
  background-color: #d32f2f;
  color: white;
  border-radius: 15px;
  padding: 1.5rem;
  text-align: center;
  font-size: 1.5rem;
  box-shadow: 0 0 15px rgba(255,0,0,0.7);
  transition: transform 0.5s, opacity 0.5s, box-shadow 0.3s;
  opacity: 0;
  transform: translateY(-20px);
}
.patient-card.show { opacity: 1; transform: translateY(0); }
.patient-number { font-size: 3rem; font-weight: bold; }
.patient-name { margin-top: 0.5rem; font-size: 1.5rem; font-weight: 500; }

@media (max-width: 768px) {
  .queue-container { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem; padding: 1rem; }
  .patient-card { padding: 1rem; font-size: 1.2rem; }
  .patient-number { font-size: 2rem; }
  .patient-name { font-size: 1.2rem; }
}

/* ===== ANTISLEEP ДЛЯ OLED / GOOGLE TV ===== */
@keyframes antiSleep {
  0%   { transform: translate(0, 0); }
  50%  { transform: translate(1px, 0); }
  100% { transform: translate(0, 0); }
}
body { animation: antiSleep 30s infinite linear; overflow: hidden; }

/* ===== Overlay уведомлений ===== */
.notice-overlay{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,.65);
  opacity:0; pointer-events:none; transition:opacity .35s ease;
  z-index:9998;
}
.notice-overlay.show{ opacity:1; pointer-events:auto; }
.notice-card{
  max-width: 900px; margin:0 24px; padding:24px 28px;
  background:#fff3cd; color:#111; border-radius:16px;
  box-shadow:0 8px 30px rgba(0,0,0,.35);
  text-align:center;
}
.notice-title{ font-size:2rem; font-weight:800; margin-bottom:12px; }
.notice-text{ font-size:1.5rem; font-weight:700; }
</style>
</head>

<body>

<!-- антисон видео -->
<video
  id="antiSleepVideo"
  autoplay
  loop
  muted
  playsinline
  preload="auto"
  style="position: fixed; top:0; left:0; width:1px; height:1px; opacity:0; pointer-events:none; z-index:-1;">
  <source src="antisleep.mp4" type="video/mp4">
</video>

<div class="header">Електронна черга</div>
<div class="header">Шановні пацієнти! Після зникнення поточного номера на екрані наступний номер може заходити до кабінету №3.</div>

<div class="queue-container" id="queueScreen" tabindex="0"></div>

<!-- ✅ Overlay -->
<div id="noticeOverlay" class="notice-overlay" aria-hidden="true">
  <div class="notice-card" role="dialog" aria-live="polite" aria-modal="true">
    <div class="notice-title">Шановні пацієнти!</div>
    <div class="notice-text"></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ===================== FIREBASE ===================== */
const firebaseConfig = {
  apiKey: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
  authDomain: "hospital-queue.firebaseapp.com",
  databaseURL: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "hospital-queue",
  storageBucket: "hospital-queue.appspot.com",
  messagingSenderId: "23042968926",
  appId: "1:23042968926:web:9c75f87c5337af630653cf"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===================== UI ===================== */
const queueScreen = document.getElementById('queueScreen');
const noticeOverlay = document.getElementById('noticeOverlay');
let currentCards = {};

/* ===================== QUEUE RENDER ===================== */
function createCard(key, data) {
  const card = document.createElement('div');
  card.className = 'patient-card';
  card.innerHTML = `
    <div class="patient-number">№${key}</div>
    <div class="patient-name">${data?.name ?? ''}</div>
  `;
  queueScreen.appendChild(card);
  setTimeout(() => card.classList.add('show'), 50);
  return card;
}

db.ref('queue').on('value', (snapshot) => {
  const newKeys = new Set();

  snapshot.forEach((s) => {
    const data = s.val();
    if (!data) return;

    if (data.status === 'waiting') {
      newKeys.add(s.key);
      if (!currentCards[s.key]) currentCards[s.key] = createCard(s.key, data);
    }
  });

  for (const key in currentCards) {
    if (!newKeys.has(key)) {
      const card = currentCards[key];
      card.classList.remove('show');
      setTimeout(() => card.remove(), 500);
      delete currentCards[key];
    }
  }
});

/* ===================== OVERLAY (POPUP) ===================== */
let noticeTimer = null;

function showOverlay(title, text, ms) {
  noticeOverlay.querySelector('.notice-title').textContent = title;
  noticeOverlay.querySelector('.notice-text').textContent = text;
  noticeOverlay.classList.add('show');
  noticeOverlay.setAttribute('aria-hidden', 'false');

  if (noticeTimer) clearTimeout(noticeTimer);
  noticeTimer = setTimeout(() => {
    noticeOverlay.classList.remove('show');
    noticeOverlay.setAttribute('aria-hidden', 'true');
  }, ms);
}

// каждые 5 минут (ВАЖНО: без cancel(), чтобы не ломать очередь)
function showFiveMinNotice() {
  showOverlay(
    'Шановні пацієнти!',
    "Для оформлення історії хвороби ОБОВ'ЯЗКОВО необхідно отримати підпис на електронному направленні!",
    8000
  );
}

/* ===================== VOICE (TTS) ===================== */
let voicesLoaded = false;
let voices = [];

function loadVoices() {
  voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
  voicesLoaded = !!voices.length;
}
if ('speechSynthesis' in window) {
  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;
}

function pickUkVoice() {
  if (!voicesLoaded) loadVoices();
  return voices.find(v => v.lang === 'uk-UA')
      || voices.find(v => v.lang && v.lang.startsWith('uk'))
      || voices[0]
      || null;
}

// Без кнопок: пробуем говорить, если браузер разрешит.
// Если ТВ блокирует — это ограничение браузера (не кода), но на некоторых ТВ работает как у тебя было.
function safeSpeak(text, { cancelFirst = true } = {}) {
  if (!('speechSynthesis' in window)) return;

  try {
    const u = new SpeechSynthesisUtterance(text);
    const v = pickUkVoice();
    if (v) u.voice = v;
    u.lang = 'uk-UA';
    u.rate = 0.9;
    u.pitch = 1;

    if (cancelFirst) speechSynthesis.cancel();
    speechSynthesis.speak(u);

    // маленький retry, если внезапно не стартануло
    setTimeout(() => {
      if (speechSynthesis.speaking || speechSynthesis.pending) return;
      try {
        if (cancelFirst) speechSynthesis.cancel();
        speechSynthesis.speak(u);
      } catch(e) {}
    }, 350);

  } catch (e) {
    console.warn('TTS error:', e);
  }
}

function speakQueueNumber(number) {
  safeSpeak(`Пацієнт з номером ${number}, Ви наступний`, { cancelFirst: true });
}

/* ===================== CALL EVENT FROM REGISTRAR ===================== */
// Ожидаем, что регистратор пишет:
// /call = { number: <nextNumber>, ts: Date.now() }
let lastCallTs = 0;

db.ref('call').on('value', snap => {
  const data = snap.val();
  if (!data) return;
  if (!data.ts || !data.number) return;

  if (data.ts <= lastCallTs) return;  // защита от повторов
  lastCallTs = data.ts;

  speakQueueNumber(data.number);
});

/* ===================== MINUTE OF SILENCE @ 09:00 (Kyiv) ===================== */
let lastSilenceDate = '';

function getKyivParts() {
  const parts = new Intl.DateTimeFormat('en-GB', {
    timeZone: 'Europe/Kyiv',
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit',
    hour12: false
  }).formatToParts(new Date());

  const m = {};
  for (const p of parts) if (p.type !== 'literal') m[p.type] = p.value;

  return { dateKey: `${m.year}-${m.month}-${m.day}`, hour: m.hour, minute: m.minute };
}

function runMinuteOfSilence() {
  showOverlay('Хвилина мовчання', 'Просимо вшанувати пам’ять загиблих.', 60000);
  // тут cancelFirst=true — чтобы перебить возможную очередь
  safeSpeak('Хвилина мовчання', { cancelFirst: true });
}

function checkMinuteOfSilence() {
  const now = getKyivParts();
  const TARGET_HOUR = '09';
  const TARGET_MIN  = '00';

  if (now.hour === TARGET_HOUR && now.minute === TARGET_MIN && now.dateKey !== lastSilenceDate) {
    lastSilenceDate = now.dateKey;
    runMinuteOfSilence();
  }
}

/* ===================== START TIMERS ===================== */
window.addEventListener('load', () => {
  // 5 минутные уведомления
  setTimeout(showFiveMinNotice, 5000);
  setInterval(showFiveMinNotice, 5 * 60 * 1000);

  // минута молчания 09:00
  checkMinuteOfSilence();
  setInterval(checkMinuteOfSilence, 20 * 1000);
});
</script>

</body>
</html>
