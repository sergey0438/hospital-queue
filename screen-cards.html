<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ —á–µ—Ä–≥–∞</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body {
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #000;
  color: #fff;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: url('./bg_logo.png') no-repeat center center;
  background-size: 100%;
}

.header {
  width: 100%;
  text-align: center;
  padding: 1rem 0;
  background-color: rgba(0,0,0,0.6);
  font-size: 2rem;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.queue-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1rem;
  align-content: start;
  padding: 2rem;
  width: 100%;
  max-width: 1200px;
  height: calc(100vh - 220px);
  overflow-y: auto;
  overflow-x: hidden;
  margin-top: 2rem;
  scroll-behavior: smooth;
}
.queue-container::-webkit-scrollbar { display: none; }

.patient-card {
  background-color: #d32f2f;
  color: white;
  border-radius: 15px;
  padding: 1.5rem;
  text-align: center;
  font-size: 1.5rem;
  box-shadow: 0 0 15px rgba(255,0,0,0.7);
  transition: transform 0.5s, opacity 0.5s;
  opacity: 0;
  transform: translateY(-20px);
}
.patient-card.show { opacity: 1; transform: translateY(0); }
.patient-number { font-size: 3rem; font-weight: bold; }
.patient-name { margin-top: 0.5rem; font-size: 1.2rem; font-weight: 600; }

@keyframes antiSleep {
  0%   { transform: translate(0, 0); }
  50%  { transform: translate(1px, 0); }
  100% { transform: translate(0, 0); }
}
body { animation: antiSleep 30s infinite linear; overflow: hidden; }

/* Overlay */
.notice-overlay {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.65);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.35s ease;
  z-index: 9998;
}
.notice-overlay.show { opacity: 1; pointer-events: auto; }
.notice-card {
  max-width: 900px;
  margin: 0 24px;
  padding: 24px 28px;
  background: #fff3cd;
  color: #111;
  border-radius: 16px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.35);
  text-align: center;
}
.notice-title { font-size: 2rem; font-weight: 800; margin-bottom: 12px; }
.notice-text  { font-size: 1.5rem; font-weight: 700; }
</style>
</head>
<body>

<!-- –∞–Ω—Ç–∏—Å–æ–Ω –≤–∏–¥–µ–æ -->
<video id="antiSleepVideo" autoplay loop muted playsinline preload="auto"
  style="position: fixed; top:0; left:0; width:1px; height:1px; opacity:0; pointer-events:none; z-index:-1;">
  <source src="antisleep.mp4" type="video/mp4">
</video>

<div class="header">–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ —á–µ—Ä–≥–∞</div>
<div class="header">–®–∞–Ω–æ–≤–Ω—ñ –ø–∞—Ü—ñ—î–Ω—Ç–∏! –ü—ñ—Å–ª—è –∑–Ω–∏–∫–Ω–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –Ω–æ–º–µ—Ä –º–æ–∂–µ –∑–∞—Ö–æ–¥–∏—Ç–∏ –¥–æ –∫–∞–±—ñ–Ω–µ—Ç—É ‚Ññ3.</div>
<div class="queue-container" id="queueScreen"></div>

<!-- Overlay -->
<div id="noticeOverlay" class="notice-overlay" aria-hidden="true">
  <div class="notice-card" role="dialog" aria-live="polite" aria-modal="true">
    <div class="notice-title">–®–∞–Ω–æ–≤–Ω—ñ –ø–∞—Ü—ñ—î–Ω—Ç–∏!</div>
    <div class="notice-text"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
  authDomain: "hospital-queue.firebaseapp.com",
  databaseURL: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "hospital-queue",
  storageBucket: "hospital-queue.appspot.com",
  messagingSenderId: "23042968926",
  appId: "1:23042968926:web:9c75f87c5337af630653cf"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const queueScreen = document.getElementById('queueScreen');
const noticeOverlay = document.getElementById('noticeOverlay');

let currentCards = {};
let availableVoices = [];
let lastCallTs = 0;

// ==================================================
// ‚úÖ AUTO AUDIO UNLOCK (–±–µ–∑ –∫–ª–∏–∫–∞) ‚Äî Smart TV friendly
// ==================================================
let audioUnlocked = false;
(function autoUnlockAudio() {
  try {
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if (!AudioCtx) {
      console.warn('AudioContext not available');
      return;
    }
    const ctx = new AudioCtx();

    const buffer = ctx.createBuffer(1, 1, 22050);
    const source = ctx.createBufferSource();
    source.buffer = buffer;
    source.connect(ctx.destination);
    source.start(0);

    if (ctx.state === 'running') {
      audioUnlocked = true;
      console.log('üîì Audio auto-unlocked (state=running)');
    }

    setTimeout(() => {
      if (!audioUnlocked && ctx.state === 'suspended') {
        ctx.resume().then(() => {
          audioUnlocked = true;
          console.log('üîì Audio resumed (fallback)');
        }).catch(e => console.warn('Audio resume failed:', e));
      }
    }, 500);

  } catch (e) {
    console.warn('Audio unlock error:', e);
  }
})();

// ===================
// Voices (TTS)
// ===================
function loadVoices() { 
  try { availableVoices = speechSynthesis.getVoices() || []; }
  catch(e) { availableVoices = []; }
}
loadVoices();
if ('speechSynthesis' in window) speechSynthesis.onvoiceschanged = loadVoices;

function getUkVoice() {
  if (!availableVoices.length) loadVoices();
  return (
    availableVoices.find(v => v.lang === 'uk-UA') ||
    availableVoices.find(v => (v.lang || '').toLowerCase().startsWith('uk')) ||
    availableVoices[0] ||
    null
  );
}

// ===================
// Speak
// ===================
function speakNext(number) {
  if (!('speechSynthesis' in window)) return;

  if (!audioUnlocked) {
    console.warn('üîá Audio still locked, skip speak');
    return;
  }

  const text = `–ü–∞—Ü—ñ—î–Ω—Ç –∑ –Ω–æ–º–µ—Ä–æ–º ${number}, –í–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, –ø—Ä–æ—Ö–æ–¥—å—Ç–µ.`;
  const u = new SpeechSynthesisUtterance(text);

  const v = getUkVoice();
  if (v) u.voice = v;

  u.lang = 'uk-UA';
  u.rate = 0.9;
  u.pitch = 1;

  try {
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  } catch(e) {
    console.warn('speak error:', e);
  }
}

// —Å–ª—É—à–∞–µ–º call (–µ–≥–æ –ø–∏—à–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
db.ref('call').on('value', snap => {
  const data = snap.val();
  if (!data) return;

  if (typeof data.ts === 'number' && data.ts <= lastCallTs) return;
  if (typeof data.ts === 'number') lastCallTs = data.ts;

  speakNext(data.number);
});

// –∫–∞—Ä—Ç–æ—á–∫–∏ –æ—á–µ—Ä–µ–¥–∏
function createCard(key, data) {
  const card = document.createElement('div');
  card.className = 'patient-card';
  card.innerHTML = `
    <div class="patient-number">‚Ññ${key}</div>
    <div class="patient-name">${data.name ?? ''}</div>
  `;
  queueScreen.appendChild(card);
  setTimeout(() => card.classList.add('show'), 50);
  return card;
}

db.ref('queue').on('value', (snapshot) => {
  const newKeys = new Set();

  snapshot.forEach(s => {
    const data = s.val();
    if (!data) return;

    if (data.status === 'waiting') {
      newKeys.add(s.key);
      if (!currentCards[s.key]) {
        currentCards[s.key] = createCard(s.key, data);
      }
    }
  });

  for (const key in currentCards) {
    if (!newKeys.has(key)) {
      const card = currentCards[key];
      card.classList.remove('show');
      setTimeout(() => card.remove(), 500);
      delete currentCards[key];
    }
  }
});

// Overlay helpers
let overlayTimer = null;
function showOverlay(title, text, ms) {
  noticeOverlay.querySelector('.notice-title').textContent = title;
  noticeOverlay.querySelector('.notice-text').textContent = text;
  noticeOverlay.classList.add('show');
  noticeOverlay.setAttribute('aria-hidden', 'false');

  if (overlayTimer) clearTimeout(overlayTimer);
  overlayTimer = setTimeout(() => {
    noticeOverlay.classList.remove('show');
    noticeOverlay.setAttribute('aria-hidden', 'true');
  }, ms);
}


// =======================================================
// ‚úÖ –ú–∏–Ω—É—Ça –º–æ–ª—á–∞–Ω–∏—è (Kyiv) ‚Äî FIX: –æ–∫–Ω–æ + localStorage
// =======================================================
function getKyivParts() {
  const parts = new Intl.DateTimeFormat('en-GB', {
    timeZone: 'Europe/Kyiv',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  }).formatToParts(new Date());

  const m = {};
  for (const p of parts) if (p.type !== 'literal') m[p.type] = p.value;

  return { dateKey: `${m.year}-${m.month}-${m.day}`, hour: m.hour, minute: m.minute, second: m.second };
}

const SILENCE_LS_KEY = 'silence_last_date';
let lastSilenceDate = localStorage.getItem(SILENCE_LS_KEY) || '';

async function startSilenceOneMinute() {
  const now = Date.now();

  // –µ—Å–ª–∏ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞ ‚Äî –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º
  const cur = (await db.ref('system/silence').get()).val();
  if (cur && (cur.active === true || (typeof cur.until === 'number' && cur.until > now))) {
    console.log('üü° Silence already active in DB, skip set');
    return;
  }

  console.log('‚úÖ start silence -> Firebase');
  return db.ref('system/silence').set({
    active: true,
    startedAt: now,
    until: now + 60 * 1000,
    ts: now
  });
}

async function checkSilenceSchedule() {
  const t = getKyivParts();

  // ‚úÖ –†–ï–î–ê–ö–¢–ò–†–£–ï–®–¨ –í–†–ï–ú–Ø –¢–£–¢:
  const TARGET_HOUR = '09';
  const TARGET_MIN  = '00';

  // –æ–∫–Ω–æ: 09:00:00‚Äì09:01:30
  const inWindow =
    t.hour === TARGET_HOUR &&
    (t.minute === TARGET_MIN || t.minute === '01') &&
    (t.minute === TARGET_MIN || (t.minute === '01' && Number(t.second) <= 30));

  if (!inWindow) return;
  if (t.dateKey === lastSilenceDate) return;

  lastSilenceDate = t.dateKey;
  localStorage.setItem(SILENCE_LS_KEY, lastSilenceDate);

  try {
    await startSilenceOneMinute();
  } catch (e) {
    console.warn('‚ùå startSilenceOneMinute error:', e);
    lastSilenceDate = '';
    localStorage.removeItem(SILENCE_LS_KEY);
  }
}

setInterval(checkSilenceSchedule, 10 * 1000);
checkSilenceSchedule();


// =======================================================
// ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω: —Å–ª—É—à–∞–µ–º system/silence (overlay + auto-off)
// =======================================================
let silenceTimer = null;

db.ref('system/silence').on('value', snap => {
  const v = snap.val();
  const now = Date.now();

  const active = !!v && (
    v.active === true ||
    (typeof v.until === 'number' && v.until > now)
  );

  if (active) {
    showOverlay('–•–≤–∏–ª–∏–Ω–∞ –º–æ–≤—á–∞–Ω–Ω—è', '–ü—Ä–æ—Å–∏–º–æ –≤—à–∞–Ω—É–≤–∞—Ç–∏ –ø–∞–º‚Äô—è—Ç—å –∑–∞–≥–∏–±–ª–∏—Ö.', 60000);
  } else {
    noticeOverlay.classList.remove('show');
    noticeOverlay.setAttribute('aria-hidden', 'true');
  }

  if (silenceTimer) clearTimeout(silenceTimer);

  if (active && typeof v.until === 'number') {
    const msLeft = Math.max(0, v.until - now);
    silenceTimer = setTimeout(() => {
      noticeOverlay.classList.remove('show');
      noticeOverlay.setAttribute('aria-hidden', 'true');

      // ‚úÖ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å–±—Ä–æ—Å active=false –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è
      db.ref('system/silence/active').set(false).catch(()=>{});
    }, msLeft + 200);
  }
});
</script>
</body>
</html>
