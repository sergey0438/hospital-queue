<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–†–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">
  <div class="container">
    <h1 class="mb-4">–†–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä</h1>

    <!-- –ë–∞–Ω–Ω–µ—Ä –º–∏–Ω—É—Ç—ã –º–æ–ª—á–∞–Ω–∏—è -->
    <div id="silenceBanner" class="alert alert-warning" style="display:none; font-weight:700;">
      ‚õî –ó–∞—Ä–∞–∑ —Ç—Ä–∏–≤–∞—î —Ö–≤–∏–ª–∏–Ω–∞ –º–æ–≤—á–∞–Ω–Ω—è. –î—ñ—ó —Ç–∏–º—á–∞—Å–æ–≤–æ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ.
    </div>

    <div class="input-group mb-3">
      <input type="text" id="patientName" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å –æ—Å—Ç–∞–Ω–Ω—ñ 4 —Ü–∏—Ñ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è">
      <button class="btn btn-primary" id="addBtn">–î–æ–¥–∞—Ç–∏</button>
    </div>

    <ul id="queueList" class="list-group"></ul>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
      authDomain: "hospital-queue.firebaseapp.com",
      databaseURL: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "hospital-queue",
      storageBucket: "hospital-queue.appspot.com",
      messagingSenderId: "23042968926",
      appId: "1:23042968926:web:9c75f87c5337af630653cf"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ==========================
    // SILENCE: –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ + –∑–≤—É–∫
    // ==========================

    // 1) –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ–∑–≤—É—á–∫–∏ (Safari/Chrome —Ç—Ä–µ–±—É—é—Ç 1 gesture)
    let audioUnlocked = false;
    function unlockAudioOnce() {
      if (audioUnlocked) return;
      audioUnlocked = true;

      try {
        // "–ø—É—Å—Ç–∞—è" —Ñ—Ä–∞–∑–∞ —á—Ç–æ–±—ã —Å–Ω—è—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        const u = new SpeechSynthesisUtterance(' ');
        u.lang = 'uk-UA';
        speechSynthesis.speak(u);
      } catch (e) {}

      console.log('üîä Audio unlocked');
    }
    window.addEventListener('pointerdown', unlockAudioOnce, { once: true });
    window.addEventListener('keydown', unlockAudioOnce, { once: true });

    // 2) ‚úÖ –Ø–í–ù–ê–Ø –∑–∞–≥—Ä—É–∑–∫–∞/–≤—ã–±–æ—Ä —É–∫—Ä–∞–∏–Ω—Å–∫–æ–≥–æ –≥–æ–ª–æ—Å–∞ (–∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç "—Ä—É—Å—Å–∫–æ–µ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ")
    let voices = [];
    function loadVoices() {
      voices = speechSynthesis.getVoices() || [];
      // –º–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
      // console.log('voices:', voices.map(v => `${v.lang} ‚Äî ${v.name}`));
    }
    loadVoices();
    speechSynthesis.onvoiceschanged = loadVoices;

    function getUkVoice() {
      // uk-UA –∏–ª–∏ –ª—é–±–æ–µ uk*
      return voices.find(v => v.lang === 'uk-UA' || (v.lang || '').toLowerCase().startsWith('uk')) || null;
    }

    function speakUA(text) {
      if (!('speechSynthesis' in window)) return;
      if (!audioUnlocked) return; // —Ç–∏—Ö–æ, –ø–æ–∫–∞ –Ω–µ –±—ã–ª–æ –∫–ª–∏–∫–∞

      const u = new SpeechSynthesisUtterance(text);

      // ‚úÖ –∫–ª—é—á–µ–≤–æ–µ: –Ω–∞–∑–Ω–∞—á–∞–µ–º –≥–æ–ª–æ—Å
      const uk = getUkVoice();
      if (uk) u.voice = uk;

      u.lang = 'uk-UA';
      u.rate = 0.95;
      u.pitch = 1;

      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }

    function setRegistrarBlocked(isBlocked) {
      const addBtn = document.getElementById('addBtn');
      const input = document.getElementById('patientName');
      const banner = document.getElementById('silenceBanner');

      if (addBtn) addBtn.disabled = isBlocked;
      if (input) input.disabled = isBlocked;
      if (banner) banner.style.display = isBlocked ? 'block' : 'none';

      document.querySelectorAll('.btn-exit').forEach(btn => {
        btn.disabled = isBlocked;
        btn.classList.toggle('disabled', isBlocked);
      });
    }

    let lastSilenceTsSpoken = 0;
    let silenceTimer = null;

    db.ref('system/silence').on('value', snap => {
      const v = snap.val();
      const now = Date.now();
      const active = !!v && (v.active === true || (typeof v.until === 'number' && v.until > now));

      setRegistrarBlocked(active);

      // ‚úÖ FIX: –≤–º–µ—Å—Ç–æ v.ts –∏—Å–ø–æ–ª—å–∑—É–µ–º startedAt (–∏–ª–∏ fallback)
      const eventTs = (v && typeof v.startedAt === 'number') ? v.startedAt
                    : (v && typeof v.ts === 'number') ? v.ts
                    : 0;

      // –æ–∑–≤—É—á–∏—Ç—å 1 —Ä–∞–∑ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ
      if (active && eventTs > lastSilenceTsSpoken) {
        lastSilenceTsSpoken = eventTs;
        speakUA('–£–≤–∞–≥–∞! –û–≥–æ–ª–æ—à–µ–Ω–æ —Ö–≤–∏–ª–∏–Ω—É –º–æ–≤—á–∞–Ω–Ω—è.');
      }

      // –ª–æ–∫–∞–ª—å–Ω—ã–π —Ç–∞–π–º–µ—Ä, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ —É–±—Ä–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ until
      if (silenceTimer) clearTimeout(silenceTimer);
      if (active && typeof v.until === 'number') {
        const msLeft = Math.max(0, v.until - now);
        silenceTimer = setTimeout(() => setRegistrarBlocked(false), msLeft + 200);
      }
    });

    // =====================================
    // reset –∫–∞–∂–¥—ã–π –¥–µ–Ω—å (–∫–∞–∫ —É —Ç–µ–±—è –±—ã–ª–æ)
    // =====================================
    function getKyivTodayISO() {
      return new Date().toLocaleDateString('en-CA', { timeZone: 'Europe/Kyiv' });
    }

    function checkAndResetIfNeeded() {
      const today = getKyivTodayISO();
      const rootRef = db.ref('/');

      rootRef.child('lastReset').get().then(snapshot => {
        const lastReset = snapshot.exists() ? snapshot.val() : null;
        if (lastReset === today) return;

        const updates = {};
        updates['/lastNumber'] = 0;
        updates['/queue'] = {};
        updates['/lastReset'] = today;

        rootRef.update(updates).catch(err => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –æ—á–µ—Ä–µ–¥–∏:', err));
      }).catch(err => console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è lastReset:', err));
    }

    window.addEventListener('load', () => {
      checkAndResetIfNeeded();
      initRegistrarUI();
    });

    // ======================
    // UI —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    // ======================
    function initRegistrarUI() {
      document.getElementById('addBtn').addEventListener('click', addPatient);

      db.ref('queue').on('value', snapshot => {
        const list = document.getElementById('queueList');
        list.innerHTML = '';

        snapshot.forEach(s => {
          const data = s.val();
          if (!data) return;

          if (data.status === 'waiting') {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';

            li.innerHTML = `‚Ññ${s.key} ${data.name}
              <button class="btn btn-success btn-sm btn-exit" onclick="markIn(${s.key})">
                –ü–∞—Ü—ñ—î–Ω—Ç –≤–∏–π—à–æ–≤
              </button>`;

            list.appendChild(li);
          }
        });

        // –µ—Å–ª–∏ —Å–µ–π—á–∞—Å silence –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –∑–∞–±–ª–æ–∫–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏
        db.ref('system/silence').get().then(ss => {
          const v = ss.val();
          const now = Date.now();
          const active = v && (v.active === true || (typeof v.until === 'number' && v.until > now));
          setRegistrarBlocked(!!active);
        });
      });
    }

    function addPatient() {
      const name = document.getElementById('patientName').value.trim();
      if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–∞—Ü–∏–µ–Ω—Ç–∞');

      db.ref('lastNumber').transaction(last => (last || 0) + 1, (err, committed, snapshot) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ lastNumber:', err);
          return alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ –Ω–æ–º–µ—Ä–∞');
        }
        const number = snapshot.val();
        db.ref('queue/' + number).set({ name, status: 'waiting' })
          .then(() => document.getElementById('patientName').value = '')
          .catch(e => {
            console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞:', e);
            alert('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑—É');
          });
      });
    }

    // ‚úÖ "–ü–∞—Ü—ñ—î–Ω—Ç –≤–∏–π—à–æ–≤" -> –≤—ã–∑–≤–∞—Ç—å –°–õ–ï–î–£–Æ–©–ï–ì–û (—á–µ—Ä–µ–∑ call)
    function markIn(number) {
      const queueRef = db.ref('queue');

      queueRef.once('value').then(snapshot => {
        const waitingNumbers = [];

        snapshot.forEach(s => {
          const data = s.val();
          if (data && data.status === 'waiting') {
            waitingNumbers.push(Number(s.key));
          }
        });

        // —Ç–µ–∫—É—â–∏–π –≤—ã—à–µ–ª
        db.ref('queue/' + number).update({
          status: 'in',
          announced: true
        });

        const nextNumber = Math.min(...waitingNumbers.filter(n => n !== number));

        if (nextNumber && isFinite(nextNumber)) {
          db.ref('call').set({
            number: nextNumber,
            ts: Date.now()
          });
        }
      });
    }
  </script>
</body>
</html>
