<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–†–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light p-4">
  <div class="container">
    <h1 class="mb-4">–†–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä</h1>

    <!-- ‚úÖ –ë–∞–Ω–Ω–µ—Ä –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ –≤—Ä–µ–º—è –º–∏–Ω—É—Ç—ã –º–æ–ª—á–∞–Ω–∏—è -->
    <div id="silenceBanner" class="alert alert-warning" style="display:none; font-weight:700;">
      ‚õî –ó–∞—Ä–∞–∑ —Ç—Ä–∏–≤–∞—î —Ö–≤–∏–ª–∏–Ω–∞ –º–æ–≤—á–∞–Ω–Ω—è. –î—ñ—ó —Ç–∏–º—á–∞—Å–æ–≤–æ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ.
    </div>

    <div class="input-group mb-3">
      <input type="text" id="patientName" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å –æ—Å—Ç–∞–Ω–Ω—ñ 4 —Ü–∏—Ñ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è">
      <button class="btn btn-primary" id="addBtn">–î–æ–¥–∞—Ç–∏</button>
    </div>

    <ul id="queueList" class="list-group"></ul>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
      authDomain: "hospital-queue.firebaseapp.com",
      databaseURL: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "hospital-queue",
      storageBucket: "hospital-queue.appspot.com",
      messagingSenderId: "23042968926",
      appId: "1:23042968926:web:9c75f87c5337af630653cf"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ==========================
    // SILENCE: –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ + –∑–≤—É–∫
    // ==========================

    // 1) –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ–∑–≤—É—á–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–º (Safari/TV —Ç—Ä–µ–±—É–µ—Ç 1 "user gesture")
    let audioUnlocked = false;

    function unlockAudioOnce() {
      if (audioUnlocked) return;
      audioUnlocked = true;

      try {
        // "–ø—É—Å—Ç–∞—è" —Ñ—Ä–∞–∑–∞ –∫–∞–∫ —Ä–∞–∑ "–ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç" –∞—É–¥–∏–æ –∫ –∂–µ—Å—Ç—É
        const u = new SpeechSynthesisUtterance(' ');
        u.lang = 'uk-UA';
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
      } catch (e) {}

      console.log('üîä Audio unlocked');
    }

    window.addEventListener('pointerdown', unlockAudioOnce, { once: true });
    window.addEventListener('keydown', unlockAudioOnce, { once: true });

    // 2) –û–∑–≤—É—á–∫–∞ (UA)
    function speakUA(text) {
      if (!('speechSynthesis' in window)) return;

      if (!audioUnlocked) {
        console.warn('üîá –û–∑–≤—É—á–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –±—Ä–∞—É–∑–µ—Ä–æ–º ‚Äî –∫–ª–∏–∫–Ω–∏ –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
        return;
      }

      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'uk-UA';
      u.rate = 0.95;
      u.pitch = 1;

      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }

    // 3) –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ UI —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    function setRegistrarBlocked(isBlocked) {
      const addBtn = document.getElementById('addBtn');
      const input  = document.getElementById('patientName');
      const banner = document.getElementById('silenceBanner');

      if (addBtn) addBtn.disabled = isBlocked;
      if (input)  input.disabled  = isBlocked;
      if (banner) banner.style.display = isBlocked ? 'block' : 'none';

      // –±–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ "–ü–∞—Ü—ñ—î–Ω—Ç –≤–∏–π—à–æ–≤"
      document.querySelectorAll('.btn-exit').forEach(btn => {
        btn.disabled = isBlocked;
        btn.classList.toggle('disabled', isBlocked);
      });
    }

    // 4) –°–ª–µ–¥–∏–º –∑–∞ system/silence (–µ–≥–æ —Å—Ç–∞–≤–∏—Ç –¢–í/–∫–æ–Ω—Å–æ–ª—å)
    // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Å—Ö–µ–º—É: { active: true, until: <ms>, startedAt: <ms> }
    let lastSilenceStartedAtSpoken = 0;

    function isSilenceActive(v) {
      if (!v) return false;
      const now = Date.now();

      // –∞–∫—Ç–∏–≤–Ω–∞ –µ—Å–ª–∏:
      // - active === true –∏ until –≤ –±—É–¥—É—â–µ–º
      // - –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ until –≤ –±—É–¥—É—â–µ–º (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ active –∑–∞–±—ã–ª–∏)
      const untilOk = (typeof v.until === 'number') ? (v.until > now) : false;
      return (v.active === true && untilOk) || untilOk;
    }

    db.ref('system/silence').on('value', snap => {
      const v = snap.val();

      const active = isSilenceActive(v);
      setRegistrarBlocked(active);

      if (!active) return;

      // –æ–∑–≤—É—á–∏—Ç—å 1 —Ä–∞–∑ –Ω–∞ startedAt (–∏–ª–∏ fallback –Ω–∞ until, –µ—Å–ª–∏ startedAt –Ω–µ—Ç)
      const startedAt = (v && typeof v.startedAt === 'number') ? v.startedAt
                        : (v && typeof v.until === 'number') ? v.until
                        : 0;

      if (startedAt && startedAt > lastSilenceStartedAtSpoken) {
        lastSilenceStartedAtSpoken = startedAt;
        speakUA('–£–≤–∞–≥–∞! –û–≥–æ–ª–æ—à–µ–Ω–æ —Ö–≤–∏–ª–∏–Ω—É –º–æ–≤—á–∞–Ω–Ω—è.');
      }
    });

    // =====================================
    // reset –∫–∞–∂–¥—ã–π –¥–µ–Ω—å (–∫–∞–∫ —É —Ç–µ–±—è –±—ã–ª–æ)
    // =====================================
    function getKyivTodayISO() {
      return new Date().toLocaleDateString('en-CA', { timeZone: 'Europe/Kyiv' });
    }

    function checkAndResetIfNeeded() {
      const today = getKyivTodayISO();
      const rootRef = db.ref('/');

      rootRef.child('lastReset').get().then(snapshot => {
        const lastReset = snapshot.exists() ? snapshot.val() : null;

        if (lastReset === today) return;

        const updates = {};
        updates['/lastNumber'] = 0;
        updates['/queue'] = {};
        updates['/lastReset'] = today;

        rootRef.update(updates).catch(err => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –æ—á–µ—Ä–µ–¥–∏:', err));
      }).catch(err => console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è lastReset:', err));
    }

    window.addEventListener('load', () => {
      checkAndResetIfNeeded();
      initRegistrarUI();
    });

    // ======================
    // UI —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    // ======================
    function initRegistrarUI() {
      const addBtn = document.getElementById('addBtn');
      addBtn.addEventListener('click', addPatient);

      db.ref('queue').on('value', snapshot => {
        const list = document.getElementById('queueList');
        list.innerHTML = '';

        snapshot.forEach(s => {
          const data = s.val();
          if (!data) return;

          if (data.status === 'waiting') {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';

            li.innerHTML = `‚Ññ${s.key} ${data.name}
              <button class="btn btn-success btn-sm btn-exit" onclick="markIn(${s.key})">
                –ü–∞—Ü—ñ—î–Ω—Ç –≤–∏–π—à–æ–≤
              </button>`;

            list.appendChild(li);
          }
        });

        // –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–Ω–∞ –º–∏–Ω—É—Ç–∞ –º–æ–ª—á–∞–Ω–∏—è ‚Äî –ø–µ—Ä–µ–∑–∞–±–ª–æ–∫–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏
        db.ref('system/silence').get().then(ss => {
          setRegistrarBlocked(isSilenceActive(ss.val()));
        });
      });
    }

    function addPatient() {
      // –∑–∞—â–∏—Ç–∞ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
      db.ref('system/silence').get().then(ss => {
        if (isSilenceActive(ss.val())) {
          alert('–ó–∞—Ä–∞–∑ —Ç—Ä–∏–≤–∞—î —Ö–≤–∏–ª–∏–Ω–∞ –º–æ–≤—á–∞–Ω–Ω—è. –î—ñ—ó —Ç–∏–º—á–∞—Å–æ–≤–æ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ.');
          return;
        }

        const name = document.getElementById('patientName').value.trim();
        if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–∞—Ü–∏–µ–Ω—Ç–∞');

        db.ref('lastNumber').transaction(last => (last || 0) + 1, (err, committed, snapshot) => {
          if (err) {
            console.error('–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ lastNumber:', err);
            return alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ –Ω–æ–º–µ—Ä–∞');
          }
          const number = snapshot.val();
          db.ref('queue/' + number).set({ name, status: 'waiting' })
            .then(() => document.getElementById('patientName').value = '')
            .catch(e => {
              console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞:', e);
              alert('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑—É');
            });
        });
      });
    }

    // ‚úÖ –í–ê–ñ–ù–û: –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ü–∞—Ü—ñ—î–Ω—Ç –≤–∏–π—à–æ–≤" ‚Äî –≤—ã–∑—ã–≤–∞–µ–º –°–õ–ï–î–£–Æ–©–ï–ì–û
    function markIn(number) {
      // –∑–∞—â–∏—Ç–∞ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
      db.ref('system/silence').get().then(ss => {
        if (isSilenceActive(ss.val())) {
          alert('–ó–∞—Ä–∞–∑ —Ç—Ä–∏–≤–∞—î —Ö–≤–∏–ª–∏–Ω–∞ –º–æ–≤—á–∞–Ω–Ω—è. –î—ñ—ó —Ç–∏–º—á–∞—Å–æ–≤–æ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ.');
          return;
        }

        const queueRef = db.ref('queue');

        queueRef.once('value').then(snapshot => {
          const waitingNumbers = [];

          snapshot.forEach(s => {
            const data = s.val();
            if (data && data.status === 'waiting') {
              waitingNumbers.push(Number(s.key));
            }
          });

          // –ø–æ–º–µ—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∫–∞–∫ "in"
          db.ref('queue/' + number).update({
            status: 'in',
            announced: true
          });

          // —Å–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä
          const nextNumber = Math.min(...waitingNumbers.filter(n => n !== number));

          if (nextNumber && isFinite(nextNumber)) {
            db.ref('call').set({
              number: nextNumber,
              ts: Date.now()
            });
          }
        });
      });
    }
  </script>
</body>
</html>
