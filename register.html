<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Реєстратор</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">
<div class="container">
  <h1 class="mb-4">Реєстратор</h1>

  <div class="input-group mb-3">
    <input type="text" id="patientName" class="form-control" placeholder="Введіть ПІБ пацієнта">
    <button class="btn btn-primary" id="addBtn">Додати</button>
  </div>

  <ul id="queueList" class="list-group"></ul>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // ---------- Firebase config ----------
  const firebaseConfig = {
    apiKey: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
    authDomain: "hospital-queue.firebaseapp.com",
    databaseURL: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId: "hospital-queue",
    storageBucket: "hospital-queue.appspot.com",
    messagingSenderId: "23042968926",
    appId: "1:23042968926:web:9c75f87c5337af630653cf"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ---------- Голосовое уведомление ----------
  let soundEnabled = false;
  document.body.addEventListener('click', () => { soundEnabled = true; }, { once: true });

  function speakNumber(number) {
    if (!soundEnabled) return;
    const text = `Пацієнт номер ${number}, Ви наступний`;
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang = 'uk-UA';
    msg.rate = 0.9;
    msg.pitch = 1;
    speechSynthesis.cancel();
    speechSynthesis.speak(msg);
  }

  // ---------- Добавление пациента ----------
  document.getElementById('addBtn').addEventListener('click', () => {
    const name = document.getElementById('patientName').value.trim();
    if (!name) return alert('Введіть ім’я пацієнта');

    db.ref('lastNumber').transaction(last => (last || 0) + 1, (err, committed, snapshot) => {
      if (err) return console.error(err);
      const number = snapshot.val();
      db.ref('queue/' + number).set({ name, status: 'waiting', announced: false })
        .then(() => { document.getElementById('patientName').value = ''; })
        .catch(e => console.error(e));
    });
  });

  // ---------- Отметка "Пацієнт вийшов" ----------
  function markIn(number) {
    const ref = db.ref('queue/' + number);
    ref.update({ status: 'in', announced: false })
      .then(() => {
        // Автоматически озвучиваем следующего
        db.ref('queue').orderByKey().once('value', snapshot => {
          let nextNumber = null;
          snapshot.forEach(s => {
            const data = s.val();
            if (data.status === 'waiting' && !nextNumber) nextNumber = s.key;
          });
          if (nextNumber) speakNumber(nextNumber);
        });
      })
      .catch(e => console.error(e));
  }

  // ---------- Слушаем очередь и отображаем список ----------
  db.ref('queue').on('value', snapshot => {
    const list = document.getElementById('queueList');
    list.innerHTML = '';
    snapshot.forEach(s => {
      const data = s.val();
      if (!data || data.status !== 'waiting') return;
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `№${s.key} ${data.name} 
        <button class="btn btn-success btn-sm" onclick="markIn(${s.key})">Пацієнт вийшов</button>`;
      list.appendChild(li);
    });
  });
</script>
</body>
</html>
