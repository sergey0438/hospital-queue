<!-- <!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Реєстратор</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">
<div class="container">
  <h1 class="mb-4">Реєстратор</h1>

  <div class="input-group mb-3">
    <input type="text" id="patientName" class="form-control" placeholder="ПІБ пацієнта">
    <button class="btn btn-primary" onclick="addPatient()">Додати</button>
  </div>

  <ul id="queueList" class="list-group"></ul>
</div>


<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // Инициализация Firebase
  const firebaseConfig = {
    apiKey: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
      authDomain: "hospital-queue.firebaseapp.com",
      databaseURL: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "hospital-queue",
      storageBucket: "hospital-queue.appspot.com",
      messagingSenderId: "23042968926",
      appId: "1:23042968926:web:9c75f87c5337af630653cf"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Добавление пациента
  function addPatient() {
    const name = document.getElementById('patientName').value.trim();
    if (!name) return;

    db.ref('lastNumber').transaction(last => (last || 0) + 1, (err, committed, snapshot) => {
      const number = snapshot.val();
      db.ref('queue/' + number).set({ name, status: 'waiting' });
      document.getElementById('patientName').value = '';
    });
  }

  // Удаление пациента при входе в кабинет
  function markIn(number) {
    db.ref('queue/' + number).remove();
  }

  // Слушаем очередь
  db.ref('queue').on('value', snapshot => {
    const list = document.getElementById('queueList');
    list.innerHTML = '';
    snapshot.forEach(s => {
      const data = s.val();
      if (data.status === 'waiting') {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `№${s.key} ${data.name} <button class="btn btn-success btn-sm" onclick="markIn(${s.key})">В кабинет</button>`;
        list.appendChild(li);
      }
    });
  });
</script>
</body>
</html>
-->

<!--NEW-->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Реєстратор</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">
  <div class="container">
    <h1 class="mb-4">Реєстратор</h1>

    <div class="input-group mb-3">
      <input type="text" id="patientName" class="form-control" placeholder="Введіть останні 4 цифри направлення">
      <button class="btn btn-primary" id="addBtn">Додати</button>
    </div>

    <ul id="queueList" class="list-group"></ul>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ---------- CONFIG: вставь свои данные ----------
    const firebaseConfig = {
      apiKey: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
      authDomain: "hospital-queue.firebaseapp.com",
      databaseURL: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "hospital-queue",
      storageBucket: "hospital-queue.appspot.com",
      messagingSenderId: "23042968926",
      appId: "1:23042968926:web:9c75f87c5337af630653cf"
    };
    // -----------------------------------------------

    // Инициализация Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Функция: получаем "сегодня" в часовом поясе Kyiv в формате YYYY-MM-DD
    function getKyivTodayISO() {
      // toLocaleDateString с локалью en-CA даёт YYYY-MM-DD
      return new Date().toLocaleDateString('en-CA', { timeZone: 'Europe/Kyiv' });
    }

    // Функция: выполняем проверку даты и при необходимости сбрасываем очередь
    function checkAndResetIfNeeded() {
      const today = getKyivTodayISO(); // например "2025-12-10"
      const rootRef = db.ref('/');

      // Читаем lastReset
      rootRef.child('lastReset').get().then(snapshot => {
        const lastReset = snapshot.exists() ? snapshot.val() : null;

        if (lastReset === today) {
          // Уже сброшено сегодня — ничего не делаем
          console.log('Сброс не нужен, уже сегодня:', today);
          return;
        }

        // Если lastReset пустой или отличается — выполняем сброс
        console.log('Сбрасываем очередь — предыдущая дата:', lastReset, 'текущая:', today);

        // Подготавливаем пакетное обновление (атомарно)
        const updates = {};
        updates['/lastNumber'] = 0;
        updates['/queue'] = {};      // делаем пустой объект очереди
        updates['/lastReset'] = today;

        rootRef.update(updates)
          .then(() => {
            console.log('Очередь успешно сброшена. lastReset =', today);
          })
          .catch(err => {
            console.error('Ошибка при сбросе очереди:', err);
          });

      }).catch(err => {
        console.error('Ошибка чтения lastReset:', err);
      });
    }

    // Вызовем проверку при загрузке страницы
    window.addEventListener('load', () => {
      checkAndResetIfNeeded();
      initRegistrarUI();
    });

    // ---------- остальной код регистратора ----------
    function initRegistrarUI() {
      const addBtn = document.getElementById('addBtn');
      addBtn.addEventListener('click', addPatient);

      // Слушаем очередь и отображаем внизу
      db.ref('queue').on('value', snapshot => {
        const list = document.getElementById('queueList');
        list.innerHTML = '';
        snapshot.forEach(s => {
          const data = s.val();
          if (!data) return;
          if (data.status === 'waiting') {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            // s.key — номер очереди
            li.innerHTML = `№${s.key} ${data.name} <button class="btn btn-success btn-sm" onclick="markIn(${s.key})">Пацієнт вийшов</button>`;
            list.appendChild(li);
          }
        });
      });
    }

    // Добавление пациента
    function addPatient() {
      const name = document.getElementById('patientName').value.trim();
      if (!name) return alert('Введите имя пациента');

      // Авто-инкремент lastNumber транзакцией
      db.ref('lastNumber').transaction(last => (last || 0) + 1, (err, committed, snapshot) => {
        if (err) {
          console.error('Ошибка транзакции lastNumber:', err);
          return alert('Ошибка при выдаче номера');
        }
        const number = snapshot.val();
        db.ref('queue/' + number).set({ name, status: 'waiting' })
          .then(() => {
            document.getElementById('patientName').value = '';
          })
          .catch(e => {
            console.error('Ошибка добавления пациента:', e);
            alert('Ошибка записи в базу');
          });
      });
    }

    // Удаление / отметка "в кабинет"
    function markIn(number) {
      // Можно полностью удалить запись
      db.ref('queue/' + number).remove().catch(e => console.error(e));
    }
    // ------------------------------------------------

    //Добавляем голосовое уведомление
    function markIn(number) {
  firebase.database().ref('queue/' + number).update({
    status: 'in',
    announced: false
  });
}
//------------------
  </script>

  

</body>
</html>
