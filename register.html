<!-- <!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–†–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">
<div class="container">
  <h1 class="mb-4">–†–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä</h1>

  <div class="input-group mb-3">
    <input type="text" id="patientName" class="form-control" placeholder="–ü–Ü–ë –ø–∞—Ü—ñ—î–Ω—Ç–∞">
    <button class="btn btn-primary" onclick="addPatient()">–î–æ–¥–∞—Ç–∏</button>
  </div>

  <ul id="queueList" class="list-group"></ul>
</div>


<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
  const firebaseConfig = {
    apiKey: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
      authDomain: "hospital-queue.firebaseapp.com",
      databaseURL: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "hospital-queue",
      storageBucket: "hospital-queue.appspot.com",
      messagingSenderId: "23042968926",
      appId: "1:23042968926:web:9c75f87c5337af630653cf"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞
  function addPatient() {
    const name = document.getElementById('patientName').value.trim();
    if (!name) return;

    db.ref('lastNumber').transaction(last => (last || 0) + 1, (err, committed, snapshot) => {
      const number = snapshot.val();
      db.ref('queue/' + number).set({ name, status: 'waiting' });
      document.getElementById('patientName').value = '';
    });
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∫–∞–±–∏–Ω–µ—Ç
  function markIn(number) {
    db.ref('queue/' + number).remove();
  }

  // –°–ª—É—à–∞–µ–º –æ—á–µ—Ä–µ–¥—å
  db.ref('queue').on('value', snapshot => {
    const list = document.getElementById('queueList');
    list.innerHTML = '';
    snapshot.forEach(s => {
      const data = s.val();
      if (data.status === 'waiting') {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `‚Ññ${s.key} ${data.name} <button class="btn btn-success btn-sm" onclick="markIn(${s.key})">–í –∫–∞–±–∏–Ω–µ—Ç</button>`;
        list.appendChild(li);
      }
    });
  });
</script>
</body>
</html>
-->

<!--NEW-->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–†–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">
  <div class="container">
    <h1 class="mb-4">–†–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä</h1>

    <div class="input-group mb-3">
      <input type="text" id="patientName" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å –æ—Å—Ç–∞–Ω–Ω—ñ 4 —Ü–∏—Ñ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è">
      <button class="btn btn-primary" id="addBtn">–î–æ–¥–∞—Ç–∏</button>
    </div>

    <ul id="queueList" class="list-group"></ul>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ---------- CONFIG: –≤—Å—Ç–∞–≤—å —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ ----------
    const firebaseConfig = {
      apiKey: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
      authDomain: "hospital-queue.firebaseapp.com",
      databaseURL: "https://kharkiv-regional-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "hospital-queue",
      storageBucket: "hospital-queue.appspot.com",
      messagingSenderId: "23042968926",
      appId: "1:23042968926:web:9c75f87c5337af630653cf"
    };
    // -----------------------------------------------

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // –§—É–Ω–∫—Ü–∏—è: –ø–æ–ª—É—á–∞–µ–º "—Å–µ–≥–æ–¥–Ω—è" –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ Kyiv –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
    function getKyivTodayISO() {
      // toLocaleDateString —Å –ª–æ–∫–∞–ª—å—é en-CA –¥–∞—ë—Ç YYYY-MM-DD
      return new Date().toLocaleDateString('en-CA', { timeZone: 'Europe/Kyiv' });
    }

    // –§—É–Ω–∫—Ü–∏—è: –≤—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–∞—Ç—ã –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å
    function checkAndResetIfNeeded() {
      const today = getKyivTodayISO(); // –Ω–∞–ø—Ä–∏–º–µ—Ä "2025-12-10"
      const rootRef = db.ref('/');

      // –ß–∏—Ç–∞–µ–º lastReset
      rootRef.child('lastReset').get().then(snapshot => {
        const lastReset = snapshot.exists() ? snapshot.val() : null;

        if (lastReset === today) {
          // –£–∂–µ —Å–±—Ä–æ—à–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
          console.log('–°–±—Ä–æ—Å –Ω–µ –Ω—É–∂–µ–Ω, —É–∂–µ —Å–µ–≥–æ–¥–Ω—è:', today);
          return;
        }

        // –ï—Å–ª–∏ lastReset –ø—É—Å—Ç–æ–π –∏–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ–º —Å–±—Ä–æ—Å
        console.log('–°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å ‚Äî –ø—Ä–µ–¥—ã–¥—É—â–∞—è –¥–∞—Ç–∞:', lastReset, '—Ç–µ–∫—É—â–∞—è:', today);

        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø–∞–∫–µ—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–∞—Ç–æ–º–∞—Ä–Ω–æ)
        const updates = {};
        updates['/lastNumber'] = 0;
        updates['/queue'] = {};      // –¥–µ–ª–∞–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç –æ—á–µ—Ä–µ–¥–∏
        updates['/lastReset'] = today;

        rootRef.update(updates)
          .then(() => {
            console.log('–û—á–µ—Ä–µ–¥—å —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω–∞. lastReset =', today);
          })
          .catch(err => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –æ—á–µ—Ä–µ–¥–∏:', err);
          });

      }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è lastReset:', err);
      });
    }

    // –í—ã–∑–æ–≤–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('load', () => {
      checkAndResetIfNeeded();
      initRegistrarUI();
    });

    // ---------- –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ----------
    function initRegistrarUI() {
      const addBtn = document.getElementById('addBtn');
      addBtn.addEventListener('click', addPatient);

      // –°–ª—É—à–∞–µ–º –æ—á–µ—Ä–µ–¥—å –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤–Ω–∏–∑—É
      db.ref('queue').on('value', snapshot => {
        const list = document.getElementById('queueList');
        list.innerHTML = '';
        snapshot.forEach(s => {
          const data = s.val();
          if (!data) return;
          if (data.status === 'waiting') {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            // s.key ‚Äî –Ω–æ–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏
            li.innerHTML = `‚Ññ${s.key} ${data.name} <button class="btn btn-success btn-sm" onclick="markIn(${s.key})">–ü–∞—Ü—ñ—î–Ω—Ç –≤–∏–π—à–æ–≤</button>`;
            list.appendChild(li);
          }
        });
      });
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞
    function addPatient() {
      const name = document.getElementById('patientName').value.trim();
      if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–∞—Ü–∏–µ–Ω—Ç–∞');

      // –ê–≤—Ç–æ-–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç lastNumber —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
      db.ref('lastNumber').transaction(last => (last || 0) + 1, (err, committed, snapshot) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ lastNumber:', err);
          return alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ –Ω–æ–º–µ—Ä–∞');
        }
        const number = snapshot.val();
        db.ref('queue/' + number).set({ name, status: 'waiting' })
          .then(() => {
            document.getElementById('patientName').value = '';
          })
          .catch(e => {
            console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞:', e);
            alert('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑—É');
          });
      });
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ / –æ—Ç–º–µ—Ç–∫–∞ "–≤ –∫–∞–±–∏–Ω–µ—Ç"
    function markIn(number) {
  const queueRef = db.ref('queue');

  queueRef.once('value').then(snapshot => {
    const waitingNumbers = [];

    snapshot.forEach(s => {
      const data = s.val();
      if (data && data.status === 'waiting') {
        waitingNumbers.push(Number(s.key));
      }
    });

    // –ø–æ–º–µ—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∫–∞–∫ "in"
    db.ref('queue/' + number).update({
      status: 'in',
      announced: true
    });

    // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä
    const nextNumber = Math.min(
      ...waitingNumbers.filter(n => n !== number)
    );

    if (nextNumber && isFinite(nextNumber)) {
      // üîä –°–û–ë–´–¢–ò–ï –í–´–ó–û–í–ê
      db.ref('call').set({
        number: nextNumber,
        ts: Date.now()
      });
    }
  });
}


    // ------------------------------------------------
  </script>
</body>
</html>
